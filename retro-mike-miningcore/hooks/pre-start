#!/usr/bin/env bash
# Miningcore Umbrel hook: seed ~/.miningcore files before container start
# (robust against "coins.json" / "config.json" accidentally being directories)

set -e

APP_DATA_DIR="${APP_DATA_DIR:-/home/umbrel/umbrel/app-data/retro-mike-miningcore}"
MC_DIR="/home/umbrel/.miningcore"

ensure_dir() {
  mkdir -p "$1"
}

ensure_file_from() {
  local src="$1"
  local dst="$2"

  # If dst is a directory (Docker can create it), remove it
  if [ -d "$dst" ]; then
    rm -rf "$dst"
  fi

  # If dst is missing, copy from src
  if [ ! -f "$dst" ]; then
    cp -a "$src" "$dst"
  fi
}

echo "== Miningcore pre-start: ensure ~/.miningcore exists =="
ensure_dir "$MC_DIR"
ensure_dir "$MC_DIR/pools.d"
ensure_dir "$MC_DIR/wallet-backups"

echo "== Seed base files (and fix wrong types) =="
ensure_file_from "$APP_DATA_DIR/coins.json"        "$MC_DIR/coins.json"
ensure_file_from "$APP_DATA_DIR/assets/fees.json"  "$MC_DIR/fees.json"
ensure_file_from "$APP_DATA_DIR/assets/config.base.json" "$MC_DIR/config.base.json"

# config.json must be a file (never a directory)
if [ -d "$MC_DIR/config.json" ]; then
  rm -rf "$MC_DIR/config.json"
fi

if [ ! -f "$MC_DIR/config.json" ]; then
  # Render from base + pools.d fragments (may still produce 0 pools; that's fine)
  python3 "$APP_DATA_DIR/scripts/render-config.py" >/dev/null 2>&1 || true
fi

# Fallback: if render failed and config.json still missing, copy base
if [ ! -f "$MC_DIR/config.json" ]; then
  cp -a "$MC_DIR/config.base.json" "$MC_DIR/config.json"
fi

echo "== Ownership/permissions (uid 1000 = umbrel) =="
chown -R 1000:1000 "$MC_DIR" 2>/dev/null || true
find "$MC_DIR" -type d -exec chmod 755 {} + 2>/dev/null || true
find "$MC_DIR" -type f -exec chmod 644 {} + 2>/dev/null || true

echo "OK"

#!/usr/bin/env bash

APP_DATA_DIR="${APP_DATA_DIR:-/home/umbrel/umbrel/app-data/retro-mike-postgres}"
SCHEMA_FILE="${APP_DATA_DIR}/assets/miningcore-schema.sql"

log() { echo "[postgres post-install] $*"; }

CID="$(docker ps -q --filter name=retro-mike-postgres_db_1 | head -n1)"
if [ -z "$CID" ]; then
  log "WARN: postgres container not running yet - skipping (install continues)"
  exit 0
fi

# warten bis postgres ready
i=1
while [ $i -le 120 ]; do
  docker exec "$CID" pg_isready -U umbrel >/dev/null 2>&1 && break
  sleep 1
  i=$((i+1))
done

docker exec "$CID" pg_isready -U umbrel >/dev/null 2>&1 || {
  log "WARN: postgres not ready - skipping (install continues)"
  exit 0
}

log "ensure role miningcore ..."
docker exec "$CID" psql -U umbrel -d umbrel -tAc "SELECT 1 FROM pg_roles WHERE rolname='miningcore';" | grep -q 1 \
  || docker exec "$CID" psql -U umbrel -d umbrel -c "CREATE ROLE miningcore LOGIN PASSWORD 'miningcore';"

log "ensure database miningcore ..."
docker exec "$CID" psql -U umbrel -d umbrel -tAc "SELECT 1 FROM pg_database WHERE datname='miningcore';" | grep -q 1 \
  || docker exec "$CID" psql -U umbrel -d umbrel -c "CREATE DATABASE miningcore OWNER miningcore;"

if [ -f "$SCHEMA_FILE" ]; then
  # idempotent check (public schema)
  log "ensure schema (tables) ..."
  docker exec "$CID" psql -U umbrel -d miningcore -tAc \
    "SELECT 1 FROM information_schema.tables WHERE table_schema='public' AND table_name='shares';" | grep -q 1 \
    || docker exec -i "$CID" psql -U umbrel -d miningcore < "$SCHEMA_FILE"
else
  log "WARN: missing schema file: $SCHEMA_FILE"
fi

log "done."
exit 0

#!/usr/bin/env bash
# Seed Miningcore config files for first-time users.
# No strict-mode here on purpose (Umbrel shouldn't "kick out" SSH sessions).

APP_ID="retro-mike-mflex-node"
APP_DATA_DIR="${APP_DATA_DIR:-/home/umbrel/umbrel/app-data/${APP_ID}}"
ASSETS_DIR="${APP_DATA_DIR}/assets"
MC_DIR="/home/umbrel/.miningcore"

seed_file() {
  local src="$1"
  local dst="$2"

  if [ -d "$dst" ]; then
    rm -rf "$dst" 2>/dev/null || true
  fi

  if [ ! -f "$dst" ]; then
    cp -f "$src" "$dst" 2>/dev/null || true
  fi
}

mkdir -p "$MC_DIR" 2>/dev/null || true

if [ -f "$ASSETS_DIR/coins.json" ]; then
  seed_file "$ASSETS_DIR/coins.json" "$MC_DIR/coins.json"
fi

if [ -f "$ASSETS_DIR/config.json" ]; then
  seed_file "$ASSETS_DIR/config.json" "$MC_DIR/config.json"
fi

# Fix ownership/perms (Miningcore runs as UID 1000)
chown -R 1000:1000 "$MC_DIR" 2>/dev/null || true
find "$MC_DIR" -type d -exec chmod 755 {} + 2>/dev/null || true
find "$MC_DIR" -type f -exec chmod 644 {} + 2>/dev/null || true

exit 0
